# BAC4 v2.6.0 Integration Status

**Last Updated:** 2025-10-27
**Status:** Phase 2 In Progress (Infrastructure Complete, Wiring Partial)

---

## ‚úÖ COMPLETE - Infrastructure (Phase 1)

### Services & Core Logic
- **LayoutManagerService** (430 lines) ‚úÖ
  - Layout discovery for node files
  - Create/rename/delete layouts
  - Validation and consistency checks
  - File naming conventions

### UI Components
- **LayoutSelector** (170 lines) ‚úÖ
  - Dropdown with all available layouts
  - Current layout indicator
  - Create/rename/delete actions
  - View type icons

- **Layout Modals** (280 lines) ‚úÖ
  - CreateLayoutModal - Wizard for new layouts
  - RenameLayoutModal - Simple rename
  - DeleteLayoutModal - Confirmation dialog

### Templates & Configuration
- **Layout Templates** (130 lines) ‚úÖ
  - C4 Context, Container, Component
  - Wardley Map with axes
  - Custom blank layout
  - Pre-configured settings per type

### Styling
- **layout-selector.css** (350 lines) ‚úÖ
  - Complete responsive design
  - Dark mode support
  - Touch device optimizations
  - WCAG 2.1 AA accessibility

---

## ‚úÖ COMPLETE - Integration (Phase 2 Partial)

### Toolbar Integration
- **UnifiedToolbar.tsx** ‚úÖ
  - Layout props added to interface
  - LayoutSelector conditionally rendered
  - Positioned between DiagramTypeSelector and NodeCreationButtons
  - Callbacks for all layout actions

### File I/O Updates
- **file-io-service.ts** ‚úÖ
  - `readDiagram` now accepts optional `graphFilePath` parameter
  - Returns actual graph file path used
  - Backward compatible (defaults to basename.bac4-graph)

---

## ‚è≥ TODO - Final Integration

### Canvas View Integration

**File:** `src/ui/canvas-view.tsx`

**Required Changes:**

1. **Add Layout State**
```typescript
// Add to state management section
const [layouts, setLayouts] = React.useState<LayoutInfo[]>([]);
const [currentLayout, setCurrentLayout] = React.useState<LayoutInfo | null>(null);
const [currentGraphFilePath, setCurrentGraphFilePath] = React.useState<string | null>(null);
const [layoutManager] = React.useState(() => new LayoutManagerService(plugin.app.vault));
```

2. **Initialize Layouts on File Open**
```typescript
// In useEffect that loads diagram
React.useEffect(() => {
  if (!filePath) return;

  async function loadDiagram() {
    try {
      // Discover available layouts
      const availableLayouts = await layoutManager.getLayoutsForNodeFile(filePath);
      setLayouts(availableLayouts);

      // Load specific layout or default
      const layoutToLoad = availableLayouts.find(l => l.isCurrent) || availableLayouts[0];
      const { nodeFile, graphFile, graphFilePath } = await readDiagram(
        plugin.app.vault,
        filePath,
        layoutToLoad?.graphPath
      );

      setCurrentGraphFilePath(graphFilePath);
      setCurrentLayout(layoutToLoad);

      // ... rest of loading logic
    } catch (error) {
      console.error('Failed to load diagram:', error);
    }
  }

  loadDiagram();
}, [filePath]);
```

3. **Add Layout Action Handlers**
```typescript
// Layout switching
const handleLayoutSwitch = async (graphPath: string) => {
  if (!filePath) return;

  try {
    // Force save current state
    await forceSaveRef.current?.();

    // Load new layout
    const { nodeFile, graphFile, graphFilePath } = await readDiagram(
      plugin.app.vault,
      filePath,
      graphPath
    );

    // Update current layout
    const newLayout = layouts.find(l => l.graphPath === graphPath);
    setCurrentLayout(newLayout || null);
    setCurrentGraphFilePath(graphFilePath);

    // Convert and set nodes/edges
    const newNodes = mergeNodesAndLayout(nodeFile, graphFile);
    const newEdges = getEdgesFromGraph(graphFile);
    setNodes(newNodes);
    setEdges(newEdges);
    setTimeline(graphFile.timeline);

    new Notice(`Switched to layout: ${newLayout?.title}`);
  } catch (error) {
    new Notice('Failed to switch layout');
    console.error(error);
  }
};

// Create new layout
const handleCreateLayout = () => {
  if (!filePath) return;

  // Determine suggested view type based on current diagram
  const suggestedType = diagramType === 'wardley' ? 'wardley' :
                        diagramType === 'context' ? 'c4-context' :
                        diagramType === 'container' ? 'c4-container' :
                        diagramType === 'component' ? 'c4-component' :
                        'custom';

  new CreateLayoutModal(
    plugin.app,
    suggestedType,
    async (layoutName, viewType, copyFromCurrent) => {
      try {
        const currentGraphFile = copyFromCurrent ?
          await readBAC4GraphFile(plugin.app.vault, currentGraphFilePath!) :
          undefined;

        const newGraphPath = await layoutManager.createLayout(filePath, {
          viewType,
          layoutName,
          copyFromCurrent,
          currentGraphFile,
        });

        // Refresh layouts list
        const updatedLayouts = await layoutManager.getLayoutsForNodeFile(filePath);
        setLayouts(updatedLayouts);

        new Notice(`Created layout: ${layoutName}`);

        // Optionally switch to new layout
        await handleLayoutSwitch(newGraphPath);
      } catch (error) {
        new Notice('Failed to create layout');
        console.error(error);
      }
    }
  ).open();
};

// Rename layout
const handleRenameLayout = (graphPath: string) => {
  const layout = layouts.find(l => l.graphPath === graphPath);
  if (!layout) return;

  new RenameLayoutModal(
    plugin.app,
    layout.title,
    async (newName) => {
      try {
        await layoutManager.renameLayout(graphPath, newName);

        // Refresh layouts list
        const updatedLayouts = await layoutManager.getLayoutsForNodeFile(filePath!);
        setLayouts(updatedLayouts);

        new Notice(`Renamed layout to: ${newName}`);
      } catch (error) {
        new Notice('Failed to rename layout');
        console.error(error);
      }
    }
  ).open();
};

// Delete layout
const handleDeleteLayout = (graphPath: string) => {
  const layout = layouts.find(l => l.graphPath === graphPath);
  if (!layout) return;

  new DeleteLayoutModal(
    plugin.app,
    layout.title,
    async () => {
      try {
        await layoutManager.deleteLayout(graphPath);

        // Refresh layouts list
        const updatedLayouts = await layoutManager.getLayoutsForNodeFile(filePath!);
        setLayouts(updatedLayouts);

        new Notice(`Deleted layout: ${layout.title}`);

        // If current layout was deleted, switch to default
        if (graphPath === currentGraphFilePath) {
          const defaultLayout = updatedLayouts.find(l => l.isDefault);
          if (defaultLayout) {
            await handleLayoutSwitch(defaultLayout.graphPath);
          }
        }
      } catch (error) {
        new Notice('Failed to delete layout');
        console.error(error);
      }
    }
  ).open();
};
```

4. **Pass Props to UnifiedToolbar**
```typescript
<UnifiedToolbar
  currentType={diagramType}
  onTypeChange={diagramActions.handleDiagramTypeChange}
  onAddNode={canvasState.addNodeGeneric}
  onAddAnnotation={handleAddAnnotation}
  selectedNode={selectedNode}
  selectedAnnotationId={selectedAnnotationId}
  onDeleteNode={nodeHandlers.handleDeleteNode}
  onDeleteAnnotation={handleDeleteAnnotation}
  onRenameDiagram={handleRenameDiagram}
  onBringNodeForward={nodeHandlers.handleBringNodeForward}
  onSendNodeBackward={nodeHandlers.handleSendNodeBackward}
  onAddSnapshot={handleAddSnapshot}
  diagramName={getDiagramName(filePath)}
  timeline={timeline}
  // v2.6.0: Multiple Layouts
  layouts={layouts}
  currentLayout={currentLayout}
  onLayoutSwitch={handleLayoutSwitch}
  onCreateLayout={handleCreateLayout}
  onRenameLayout={handleRenameLayout}
  onDeleteLayout={handleDeleteLayout}
/>
```

5. **Update Save Logic**
```typescript
// In save function, use currentGraphFilePath instead of deriving it
await writeDiagram(
  plugin.app.vault,
  filePath,
  nodeFile,
  graphFile,
  currentGraphFilePath // Use actual graph file path
);
```

### Main.ts Commands

**File:** `src/main.ts`

**Required Changes:**

1. **Add Layout Manager Service**
```typescript
// Add to BAC4Plugin class
private layoutManager: LayoutManagerService;

// In onload()
this.layoutManager = new LayoutManagerService(this.app.vault);
```

2. **Add Layout Commands**
```typescript
// Create New Layout
this.addCommand({
  id: 'create-layout',
  name: 'Create New Layout',
  checkCallback: (checking: boolean) => {
    const activeView = this.app.workspace.getActiveViewOfType(BAC4CanvasView);
    if (activeView) {
      if (!checking) {
        // Trigger create layout modal from canvas view
        // This would need to be exposed via a method on BAC4CanvasView
      }
      return true;
    }
    return false;
  },
});

// Switch Layout (Command Palette)
this.addCommand({
  id: 'switch-layout',
  name: 'Switch Layout',
  checkCallback: (checking: boolean) => {
    const activeView = this.app.workspace.getActiveViewOfType(BAC4CanvasView);
    if (activeView) {
      if (!checking) {
        // Show quick picker for layouts
        // This would need layout list from canvas view
      }
      return true;
    }
    return false;
  },
});
```

---

## üìä Integration Checklist

- [x] LayoutManagerService implemented
- [x] Layout templates created
- [x] LayoutSelector component created
- [x] Layout modals created
- [x] CSS styling complete
- [x] UnifiedToolbar updated with layout props
- [x] file-io-service.ts updated for multiple layouts
- [ ] Canvas view layout state added
- [ ] Canvas view layout handlers implemented
- [ ] UnifiedToolbar layout props wired
- [ ] Save logic updated for current graph file
- [ ] Main.ts layout commands added
- [ ] Testing completed
- [ ] Documentation updated

---

## üéØ Estimated Remaining Effort

**Canvas View Integration:** 1-2 hours
- Add state management
- Implement handlers
- Wire up toolbar props
- Update save logic

**Main.ts Commands:** 30 minutes
- Add layout manager to plugin
- Create layout commands
- Test command palette integration

**Testing:** 30 minutes
- Create multiple layouts
- Switch between layouts
- Edit and verify persistence
- Test all layout operations

**Documentation:** 30 minutes
- Update CLAUDE.md
- Create user guide section
- Add examples

**Total Remaining:** 2-3 hours

---

## üöÄ Current Status

**What Works:**
- Layout discovery and management service ‚úÖ
- UI components fully functional ‚úÖ
- File I/O supports multiple layouts ‚úÖ
- Toolbar has layout selector slot ‚úÖ

**What's Missing:**
- Canvas view doesn't use layouts yet (state not added)
- No layout action handlers in canvas view
- Commands not registered in main.ts

**Next Step:**
Complete canvas view integration by adding the state and handlers listed above.

---

**Created:** 2025-10-27
**Author:** Claude Code
