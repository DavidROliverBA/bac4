# v3.0.0 Integration TODO

**Status:** Cleanup complete, integration pending
**Date:** October 23, 2025

---

## ✅ Completed

### Cleanup
- ✅ Deleted `src/services/file-io-service.ts` (v2.5/v2.6)
- ✅ Deleted `src/services/graph-file-service.ts` (v2.6)
- ✅ Deleted `src/services/migration-service.ts` (old)
- ✅ Deleted `src/types/bac4-v2-types.ts` (v2.5)
- ✅ Deleted `src/types/graph-file-types.ts` (v2.6)
- ✅ Deleted `src/types/wardley-types.ts` (not core v3.0.0)
- ✅ Deleted 13 old documentation files from root
- ✅ Deleted 9 old documentation files from docs/
- ✅ Updated `package.json` to v3.0.0
- ✅ Updated `manifest.json` to v3.0.0
- ✅ Updated `versions.json` to include v3.0.0

### v3.0.0 Code Created
- ✅ `src/types/graph-v3-types.ts` (complete type system)
- ✅ `src/services/graph-service-v3.ts` (__graph__.json management)
- ✅ `src/services/node-service-v3.ts` (node CRUD + uniqueness)
- ✅ `src/services/edge-service-v3.ts` (edge CRUD + usage tracking)
- ✅ `src/services/diagram-service-v3.ts` (.bac4 view management)
- ✅ `src/services/snapshot-service-v3.ts` (snapshots + promote)
- ✅ `src/services/hydration-service-v3.ts` (v3.0.0 ↔ React Flow)
- ✅ `src/ui/components/NodePalette.tsx` (browse/add nodes)
- ✅ `src/ui/modals/v3-modals.tsx` (all warning modals)
- ✅ `src/ui/pages/NodeExplorer.tsx` (vault-wide node browser)

---

## ❌ TODO: Integration Work

### 1. Update main.ts

**File:** `src/main.ts`

**Add imports:**
```typescript
import { GraphServiceV3 } from './services/graph-service-v3';
import { NodeServiceV3 } from './services/node-service-v3';
import { EdgeServiceV3 } from './services/edge-service-v3';
import { DiagramServiceV3 } from './services/diagram-service-v3';
import { createEmptyDiagramV3 } from './types/graph-v3-types';
```

**Add commands:**
```typescript
// Create new Context diagram (v3.0.0)
this.addCommand({
  id: 'create-context-diagram-v3',
  name: 'Create New Context Diagram (v3.0.0)',
  callback: async () => {
    // Initialize __graph__.json if needed
    const graphService = new GraphServiceV3(this.app.vault);
    await graphService.initialize();

    // Create diagram file
    const diagramService = new DiagramServiceV3(this.app.vault);
    const name = 'New Context';
    const path = `BAC4/${name}.bac4`;
    await diagramService.createDiagram(path, name, 'context');

    // Open it
    const file = this.app.vault.getAbstractFileByPath(path);
    if (file) {
      await this.app.workspace.getLeaf().openFile(file as any);
    }
  }
});

// Open Node Palette
this.addCommand({
  id: 'open-node-palette',
  name: 'Open Node Palette',
  callback: () => {
    // TODO: Toggle NodePalette visibility
    // Need to add state management to canvas-view
  }
});

// Open Node Explorer
this.addCommand({
  id: 'open-node-explorer',
  name: 'Open Node Explorer',
  callback: async () => {
    // TODO: Create new leaf with NodeExplorer page
    // Similar to how graph view works
  }
});
```

**Add file registration:**
```typescript
// Register .bac4 file type (v3.0.0)
this.registerExtensions(['bac4'], 'bac4-diagram');

this.registerView(
  'bac4-diagram-v3',
  (leaf) => new BAC4CanvasViewV3(leaf, this)
);
```

**Update file open handler:**
```typescript
this.registerEvent(
  this.app.workspace.on('file-open', async (file) => {
    if (file?.extension === 'bac4') {
      // Detect if v3.0.0 format
      const content = await this.app.vault.read(file);
      const data = JSON.parse(content);

      if (data.version === '3.0.0') {
        // Open with v3.0.0 view
        const leaf = this.app.workspace.getLeaf();
        await leaf.setViewState({
          type: 'bac4-diagram-v3',
          state: { filePath: file.path }
        });
      }
    }
  })
);
```

---

### 2. Create BAC4CanvasViewV3

**File:** `src/ui/canvas-view-v3.tsx` (NEW FILE)

**Purpose:** New canvas view that uses v3.0.0 services

**Key differences from old canvas-view:**
- Uses `HydrationServiceV3` to load/save
- Shows `NodePalette` component
- Calls modals from `v3-modals.tsx`
- Enforces unique names on node creation
- Shows warnings on global edits

**Template:**
```typescript
import { HydrationServiceV3 } from '../services/hydration-service-v3';
import { NodeServiceV3 } from '../services/node-service-v3';
import { EdgeServiceV3 } from '../services/edge-service-v3';
import { NodePalette } from './components/NodePalette';
import { NameCollisionModal, DeleteNodeModal } from './modals/v3-modals';

export class BAC4CanvasViewV3 extends ItemView {
  private hydrationService: HydrationServiceV3;
  private nodeService: NodeServiceV3;
  private edgeService: EdgeServiceV3;

  // State
  private filePath: string;
  private showNodePalette: boolean = false;

  async onOpen() {
    // Initialize services
    this.hydrationService = new HydrationServiceV3(this.app.vault);
    this.nodeService = new NodeServiceV3(this.app.vault);
    this.edgeService = new EdgeServiceV3(this.app.vault);

    // Load diagram
    const { nodes, edges } = await this.hydrationService.hydrateDiagram(this.filePath);

    // Render React canvas with nodes/edges
    // Include NodePalette component
  }

  async save() {
    // Get nodes/edges from React Flow
    await this.hydrationService.dehydrateDiagram(
      this.filePath,
      reactFlowNodes,
      reactFlowEdges
    );
  }
}
```

---

### 3. Update useNodeHandlers

**File:** `src/ui/canvas/hooks/useNodeHandlers.ts`

**Changes needed:**

**On node creation:**
```typescript
// Before creating node, check name uniqueness
const nameCheck = await nodeService.checkNameUniqueness(label);

if (!nameCheck.isUnique) {
  // Show NameCollisionModal
  const result = await new Promise((resolve) => {
    new NameCollisionModal(
      app,
      nameCheck.existingNode!,
      nameCheck.usageCount!,
      resolve
    ).open();
  });

  if (result.action === 'cancel') return;
  if (result.action === 'add-existing') {
    // Add existing node to diagram
    await diagramService.addNodeToDiagram(filePath, nameCheck.existingNode!.id);
    return;
  }
  if (result.action === 'create-new') {
    label = result.newName!; // Use new name
  }
}

// Create global node
const globalNode = await nodeService.createNode({
  type,
  label,
  description,
  // ...
});

// Add to diagram
await diagramService.addNodeToDiagram(filePath, globalNode.id);
```

**On node edit:**
```typescript
// Update global node (affects all diagrams)
await nodeService.updateNode(nodeId, {
  label,
  description,
  technology,
  // ...
});

// Show toast: "Updated globally - changes visible in all diagrams"
```

**On node delete:**
```typescript
// Get deletion info
const info = await nodeService.getNodeDeletionInfo(nodeId);

// Show DeleteNodeModal
const result = await new Promise((resolve) => {
  new DeleteNodeModal(
    app,
    info.node,
    info.diagramCount,
    info.diagrams,
    info.edgeCount,
    resolve
  ).open();
});

if (result.action === 'remove-from-diagram') {
  await diagramService.removeNodeFromDiagram(filePath, nodeId);
} else if (result.action === 'delete-globally') {
  await nodeService.deleteNode(nodeId); // Removes from everywhere
}
```

---

### 4. Update useEdgeHandlers

**File:** `src/ui/canvas/hooks/useEdgeHandlers.ts`

**On edge edit:**
```typescript
// Check how many diagrams show this edge
const edgeInfo = await edgeService.getEdgeChangeInfo(edgeId);

if (edgeInfo.diagramCount > 1) {
  // Show warning
  const confirmed = await new Promise((resolve) => {
    new EdgeChangeWarningModal(
      app,
      edgeInfo.edge,
      edgeInfo.diagramCount,
      edgeInfo.diagrams,
      resolve
    ).open();
  });

  if (!confirmed) return;
}

// Update global edge
await edgeService.updateEdge(edgeId, {
  label,
  direction,
  // ...
});
```

**On edge delete:**
```typescript
// Check usage
const edgeInfo = await edgeService.getEdgeChangeInfo(edgeId);

// Show warning
const confirmed = await new Promise((resolve) => {
  new EdgeDeleteWarningModal(
    app,
    edgeInfo.edge,
    edgeInfo.diagramCount,
    resolve
  ).open();
});

if (confirmed) {
  await edgeService.deleteEdge(edgeId);
}
```

---

### 5. Update useFileOperations

**File:** `src/ui/canvas/hooks/useFileOperations.ts`

**Load:**
```typescript
const handleLoad = async () => {
  const hydrationService = new HydrationServiceV3(vault);
  const { nodes, edges } = await hydrationService.hydrateDiagram(filePath);

  setNodes(nodes);
  setEdges(edges);
};
```

**Save:**
```typescript
const handleSave = async () => {
  const hydrationService = new HydrationServiceV3(vault);
  await hydrationService.dehydrateDiagram(filePath, nodes, edges);
};
```

---

### 6. Integrate NodePalette

**In canvas-view-v3.tsx:**
```typescript
<div className="bac4-canvas-container">
  <ReactFlowCanvas
    nodes={nodes}
    edges={edges}
    onNodesChange={...}
    onEdgesChange={...}
  />

  <NodePalette
    isOpen={showNodePalette}
    onClose={() => setShowNodePalette(false)}
    diagramType={diagramType}
    diagramPath={filePath}
    allNodes={allNodes} // From nodeService.getAllNodes()
    currentNodeIds={nodes.map(n => n.id)}
    onAddExistingNode={async (node) => {
      await diagramService.addNodeToDiagram(filePath, node.id);
      await reload();
    }}
    onCreateNewNode={async (type) => {
      // Show create modal
      // Check uniqueness
      // Create node
      // Add to diagram
    }}
  />
</div>
```

---

### 7. Integrate NodeExplorer

**Create new file:** `src/ui/views/NodeExplorerView.tsx`

```typescript
export class NodeExplorerView extends ItemView {
  getViewType() {
    return 'bac4-node-explorer';
  }

  getDisplayText() {
    return 'Node Explorer';
  }

  async onOpen() {
    const nodeService = new NodeServiceV3(this.app.vault);
    const edgeService = new EdgeServiceV3(this.app.vault);

    const nodes = await nodeService.getAllNodes();
    const edges = await edgeService.getAllEdges();

    // Render NodeExplorer component
    ReactDOM.render(
      <NodeExplorer
        nodes={nodes}
        edges={edges}
        onDeleteNodes={async (nodeIds) => {
          for (const id of nodeIds) {
            await nodeService.deleteNode(id);
          }
        }}
        onRefresh={async () => {
          // Reload data
        }}
      />,
      this.containerEl
    );
  }
}
```

**Register in main.ts:**
```typescript
this.registerView(
  'bac4-node-explorer',
  (leaf) => new NodeExplorerView(leaf)
);
```

---

## 📋 Integration Checklist

### Phase 1: Core Integration
- [ ] Create `src/ui/canvas-view-v3.tsx`
- [ ] Update `src/main.ts` - add v3.0.0 commands
- [ ] Register v3.0.0 view type
- [ ] Add file open handler for v3.0.0 format

### Phase 2: Hooks Integration
- [ ] Update `useFileOperations.ts` - use HydrationServiceV3
- [ ] Update `useNodeHandlers.ts` - use NodeServiceV3 + modals
- [ ] Update `useEdgeHandlers.ts` - use EdgeServiceV3 + modals

### Phase 3: UI Integration
- [ ] Integrate `NodePalette` into canvas view
- [ ] Create `NodeExplorerView.tsx`
- [ ] Add toggle button for NodePalette
- [ ] Add ribbon icon for Node Explorer

### Phase 4: Testing
- [ ] Test creating first v3.0.0 diagram
- [ ] Test __graph__.json creation
- [ ] Test node creation with uniqueness check
- [ ] Test name collision handling
- [ ] Test adding existing nodes
- [ ] Test global edit warnings
- [ ] Test delete (diagram vs global)
- [ ] Test edge warnings
- [ ] Test Node Explorer

### Phase 5: Documentation
- [ ] Update README.md
- [ ] Create v3.0.0 user guide
- [ ] Document migration from v2.x (manual)
- [ ] Update ROADMAP.md

---

## ⚠️ Critical Notes

### Breaking Changes
- **v3.0.0 cannot open v2.x diagrams**
- **No automatic migration**
- **Users must create new diagrams**
- **Old diagrams will not load**

### File Format Detection
The plugin needs to detect file format to avoid errors:
```typescript
const content = await vault.read(file);
const data = JSON.parse(content);

if (!data.version || data.version < '3.0.0') {
  // Show error: "This diagram uses old format. Create new v3.0.0 diagram."
  return;
}
```

### Backward Compatibility
**None.** This is intentional. v3.0.0 is a clean break.

---

## 🚀 Next Steps

1. **Create canvas-view-v3.tsx** - Start with minimal version that just loads/saves
2. **Update main.ts** - Add basic commands
3. **Test basic flow** - Create diagram, add node, save, reload
4. **Add modals** - Integrate warnings one by one
5. **Add NodePalette** - Enable browsing existing nodes
6. **Add NodeExplorer** - Vault-wide view
7. **Polish** - Error handling, loading states, UX improvements

**Estimated time:** 4-6 hours of focused work

---

**Current status:** Ready for integration work to begin.

*Generated: October 23, 2025*
