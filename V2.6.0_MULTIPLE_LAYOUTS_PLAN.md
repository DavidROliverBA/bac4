# BAC4 v2.6.0 - Multiple Layout Support

**Goal:** Enable multiple presentation views of the same semantic data, fully leveraging the v2.5.0 dual-file architecture.

## Vision

One `.bac4` file (semantic data) â†’ Multiple `.bac4-graph` files (different views)

**Example:**
```
Context.bac4                    # Semantic: Systems, Actors, Properties
â”œâ”€â”€ Context-C4.bac4-graph      # View 1: Traditional C4 Context layout
â”œâ”€â”€ Context-Wardley.bac4-graph # View 2: Wardley Map positioning
â””â”€â”€ Context-Timeline.bac4-graph # View 3: Chronological evolution view
```

## Benefits

1. **Same Data, Multiple Perspectives** - View architecture from different angles without duplication
2. **True Separation of Concerns** - Edit properties once, see in all views
3. **Stakeholder-Specific Views** - Different layouts for different audiences
4. **Evolution Tracking** - Timeline views show system evolution
5. **Cross-Paradigm Analysis** - Compare C4 vs Wardley representations

---

## Architecture

### File Naming Convention

```
<base-name>.bac4                    # Semantic data (nodes, properties, knowledge)
<base-name>-<view-name>.bac4-graph  # Presentation view

Examples:
- API-Gateway.bac4
- API-Gateway-C4.bac4-graph
- API-Gateway-Wardley.bac4-graph
- API-Gateway-Evolution.bac4-graph
```

### Graph File Points to Node File

```typescript
// API-Gateway-C4.bac4-graph
{
  version: "2.5.1",
  metadata: {
    nodeFile: "API-Gateway.bac4",        // Reference to semantic data
    graphId: "c4-view-123",
    title: "API Gateway - C4 Context View",
    viewType: "c4-context",
    created: "2025-10-27T12:00:00Z",
    updated: "2025-10-27T12:00:00Z"
  },
  timeline: { /* snapshots for this view */ },
  config: { /* layout config for this view */ }
}
```

---

## Implementation Plan

### Phase 1: Layout Management Service (2-3 hours)

Create `src/services/layout-manager-service.ts`

**Features:**
- Discover all graph files for a given node file
- Create new layouts from templates
- Switch between layouts
- Rename/delete layouts
- Validate graph-to-node file consistency

**Key Methods:**
```typescript
class LayoutManagerService {
  // Discover all layouts for a node file
  async getLayoutsForNodeFile(nodeFilePath: string): Promise<LayoutInfo[]>

  // Create new layout from template
  async createLayout(
    nodeFilePath: string,
    viewType: ViewType,
    layoutName: string
  ): Promise<string>

  // Switch active layout
  async switchLayout(
    nodeFilePath: string,
    graphFilePath: string
  ): Promise<void>

  // Delete layout
  async deleteLayout(graphFilePath: string): Promise<void>

  // Rename layout
  async renameLayout(
    oldPath: string,
    newName: string
  ): Promise<string>
}
```

### Phase 2: Layout Selector UI (1-2 hours)

Create `src/ui/components/LayoutSelector.tsx`

**Features:**
- Dropdown showing all available layouts
- Current layout indicator
- Quick switch between layouts
- "+" button to create new layout
- Layout type icons (C4, Wardley, Timeline, Custom)

**Location:** Toolbar, next to diagram title

**UI Mockup:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ“Š C4 Context View â–¾]  [+]  [Settings] [Export]â”‚
â”‚   â”œâ”€ C4 Context View âœ“                          â”‚
â”‚   â”œâ”€ Wardley Map View                           â”‚
â”‚   â”œâ”€ Timeline View                              â”‚
â”‚   â””â”€ Create New Layout...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Layout Templates (1 hour)

Create layout templates for common view types:

**Templates:**
1. **C4 Context** - Hierarchical top-down layout
2. **C4 Container** - Grouped by system boundaries
3. **C4 Component** - Detailed component view
4. **Wardley Map** - Evolution Ã— Visibility positioning
5. **Timeline** - Chronological left-to-right
6. **Custom** - Blank canvas

**Template Location:** `src/templates/layout-templates.ts`

### Phase 4: Integration (2-3 hours)

**File Operations:**
- Update `useFileOperations` hook to support multiple layouts
- Ensure save operations update correct graph file
- Handle layout switching without losing unsaved changes

**Canvas View:**
- Detect available layouts on file open
- Show layout selector in toolbar
- Reload canvas when layout switched

**Commands:**
- "Create New Layout" command
- "Switch Layout" command palette
- "Delete Layout" command

### Phase 5: Testing (1-2 hours)

**Test Cases:**
1. Create multiple layouts for same node file
2. Edit node properties â†’ verify all layouts update
3. Switch between layouts â†’ verify no data loss
4. Delete layout â†’ verify node file unaffected
5. Rename layout â†’ verify references update
6. Export each layout independently

---

## User Workflow

### Creating Multiple Layouts

1. User creates `Context.bac4` with C4 Context diagram
2. User clicks "+ New Layout" button
3. Dialog: "Choose layout type: C4 / Wardley / Timeline / Custom"
4. User selects "Wardley Map"
5. System creates `Context-Wardley.bac4-graph`
6. System opens Wardley view with same nodes, different positioning
7. User arranges nodes in Wardley format (visibility Ã— evolution)
8. User switches back to C4 view â†’ original layout preserved

### Switching Between Layouts

1. User opens `Context.bac4`
2. Toolbar shows: "ğŸ“Š C4 Context View â–¾"
3. User clicks dropdown
4. Sees: "C4 Context View âœ“", "Wardley Map View"
5. Clicks "Wardley Map View"
6. Canvas reloads with Wardley positioning
7. All node properties identical, layout different

### Editing Across Layouts

1. User in C4 view, edits "API Gateway" description
2. User switches to Wardley view
3. "API Gateway" description updated automatically
4. Position different, properties synchronized

---

## Technical Details

### File I/O Changes

**Current:**
```typescript
// Read: Loads Context.bac4 + Context.bac4-graph (default)
await readDiagram(vault, 'Context.bac4');

// Write: Saves both files
await writeDiagram(vault, 'Context.bac4', nodeFile, graphFile);
```

**Enhanced:**
```typescript
// Read: Specify which graph file to load
await readDiagram(vault, 'Context.bac4', 'Context-Wardley.bac4-graph');

// Discover all layouts
const layouts = await getLayouts(vault, 'Context.bac4');
// Returns: ['Context.bac4-graph', 'Context-Wardley.bac4-graph', 'Context-Timeline.bac4-graph']

// Write: Save to active graph file
await writeDiagram(vault, 'Context.bac4', nodeFile, activeGraphFile);
```

### Layout Metadata

Each `.bac4-graph` file includes:

```typescript
{
  metadata: {
    nodeFile: "Context.bac4",           // Link to semantic data
    graphId: "wardley-view-abc123",     // Unique ID
    title: "Context - Wardley View",    // Display name
    viewType: "wardley",                // Layout type
    created: "2025-10-27T12:00:00Z",
    updated: "2025-10-27T12:30:00Z"
  }
}
```

### Backward Compatibility

**Default Behavior:**
- If only `Context.bac4` exists, create default `Context.bac4-graph`
- If only `Context.bac4-graph` exists (old format), works as before
- New multi-layout features opt-in, not breaking

---

## UI/UX Design

### Layout Selector Component

```tsx
interface LayoutSelectorProps {
  nodeFilePath: string;
  currentLayout: string;
  layouts: LayoutInfo[];
  onLayoutSwitch: (graphPath: string) => void;
  onCreateLayout: () => void;
  onDeleteLayout: (graphPath: string) => void;
}

interface LayoutInfo {
  graphPath: string;
  title: string;
  viewType: ViewType;
  updated: string;
  isCurrent: boolean;
}
```

### Create Layout Dialog

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create New Layout                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layout Name: [Wardley Map View____]     â”‚
â”‚                                         â”‚
â”‚ Layout Type:                            â”‚
â”‚  âšª C4 Context                          â”‚
â”‚  âšª C4 Container                        â”‚
â”‚  âšª C4 Component                        â”‚
â”‚  âš« Wardley Map                         â”‚
â”‚  âšª Timeline                            â”‚
â”‚  âšª Custom                              â”‚
â”‚                                         â”‚
â”‚ Initial Layout:                         â”‚
â”‚  âš« Start blank                         â”‚
â”‚  âšª Copy current layout                 â”‚
â”‚                                         â”‚
â”‚         [Cancel]  [Create Layout]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Documentation

### User Guide

**Topic:** "Working with Multiple Layouts"

Content:
- What are layouts and why use them?
- Creating your first additional layout
- Switching between layouts
- Best practices for multi-layout diagrams
- Use cases: C4 + Wardley, Timeline views, Stakeholder views

### Developer Guide

**Topic:** "Multiple Layout Architecture"

Content:
- File naming conventions
- How graph files reference node files
- Layout discovery algorithm
- Creating custom view types
- Layout templates

---

## Success Metrics

### User Adoption
- % of users creating multiple layouts
- Average number of layouts per diagram
- Most popular layout combinations

### Technical
- Layout switch time < 500ms
- No data loss during switches
- Backward compatibility maintained

---

## Risks & Mitigations

### Risk: User Confusion
**Mitigation:** Clear UI, tooltips, documentation, "Why use multiple layouts?" help

### Risk: File Proliferation
**Mitigation:** Group layouts visually in file explorer, naming conventions

### Risk: Data Inconsistency
**Mitigation:** Validation on load, ensure nodeFile reference correct

### Risk: Performance
**Mitigation:** Lazy load layouts, cache node file, efficient diff algorithm

---

## Future Enhancements (Post v2.6.0)

### v2.7.0: Layout Synchronization
- Live sync: Changes in one layout visible in other open layouts
- Split view: Two layouts side-by-side

### v2.8.0: Layout Comparison
- Diff view: Highlight differences between layouts
- Merge tool: Resolve layout conflicts

### v3.0.0: Collaborative Layouts
- Team members work on different layouts simultaneously
- Layout-specific permissions

---

## Estimated Effort

| Phase | Hours | Priority |
|-------|-------|----------|
| Layout Manager Service | 2-3 | Critical |
| Layout Selector UI | 1-2 | Critical |
| Layout Templates | 1 | High |
| Integration | 2-3 | Critical |
| Testing | 1-2 | High |
| **Total** | **7-11 hours** | - |

**Timeline:** 2-3 days focused development

---

## Implementation Checklist

- [ ] Create LayoutManagerService
- [ ] Implement layout discovery
- [ ] Create LayoutSelector component
- [ ] Add layout templates
- [ ] Update useFileOperations hook
- [ ] Add create layout command
- [ ] Add switch layout command
- [ ] Add delete layout command
- [ ] Update toolbar to show layout selector
- [ ] Write unit tests
- [ ] Write integration tests
- [ ] Update documentation
- [ ] Update CLAUDE.md with patterns
- [ ] Create user guide
- [ ] Test backward compatibility

---

**Version:** v2.6.0
**Status:** Planned
**Priority:** High
**Dependencies:** v2.5.0 dual-file format âœ…
**Next:** v2.7.0 AI-Enhanced Design

---

**Created:** 2025-10-27
**Author:** Claude Code
**Last Updated:** 2025-10-27
