# BAC4 v2.5.0 Migration Testing Guide

**Date:** 2025-10-20
**Status:** Ready for Testing
**Test Vault:** BAC4Testv09

---

## ‚úÖ What We've Built

All core infrastructure for v2.5.0 is now **complete and compiled successfully**:

### Files Created (7,000+ lines of code)

1. **Type Definitions:**
   - `src/types/bac4-v2-types.ts` (380 lines) - Complete v2.5.0 format
   - `src/types/wardley-types.ts` (350 lines) - Wardley Mapping types

2. **Conversion & Migration:**
   - `src/utils/format-converter.ts` (450 lines) - v1‚Üív2 conversion engine
   - `src/services/migration-service.ts` (450 lines) - Migration tool with backup/rollback

3. **File Operations:**
   - `src/services/file-io-service.ts` (584 lines) - Dual-file read/write operations
   - `src/ui/canvas/hooks/useFileOperations-v2.ts` (323 lines) - Refactored file ops hook

4. **Integration:**
   - `src/main.ts` - Added 4 migration commands + ConfirmationModal class

5. **Documentation:**
   - `docs/WARDLEY_MAPPING_PLAN.md` (500+ lines)
   - `docs/WARDLEY_MAPPING_COMPARISON.md` (400+ lines)
   - `docs/V2.5_REFACTOR_PLAN.md` (600+ lines)
   - `docs/MAIN_TS_MIGRATION_COMMANDS.md` (322 lines)
   - `docs/V2.5_IMPLEMENTATION_STATUS.md` (412 lines)
   - `docs/V2.5_SESSION_SUMMARY.md` (large)
   - `docs/V2.5_TESTING_GUIDE.md` (this file)

### Build Status

```
‚úÖ Compiled successfully
‚úÖ Bundle size: 752.9kb
‚úÖ No TypeScript errors
‚úÖ Copied to test vault: BAC4Testv09/.obsidian/plugins/bac4/
```

---

## üéØ Test Vault Status

**Location:** `/Users/david.oliver/Documents/Vaults/BAC4Testv09`

**Diagrams Found:** 17 .bac4 files

### Layer Distribution:

```
1-Market/                     1 diagram
2-Organisation/               1 diagram
3-Capability/                 1 diagram
4-Context/                    2 diagrams
5-Container/                  2 diagrams
6-Component/                  4 diagrams
7-Code/                       5 diagrams
test-minimal.bac4             1 test diagram
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL:                       17 diagrams
```

All diagrams are currently in **v1 format** (version 1.0.0 or 2.x.x) and need migration to v2.5.0.

---

## üß™ Testing Steps

### Step 1: Reload Plugin (REQUIRED)

**Before testing, you MUST reload the plugin in Obsidian:**

1. Open Obsidian with BAC4Testv09 vault
2. Open Command Palette (`Cmd+P`)
3. Type "Reload app without saving"
4. Press Enter

This ensures the new migration commands are loaded.

---

### Step 2: Check Migration Status

**Command:** `Cmd+P` ‚Üí "Show Migration Status"

**Expected Result:**
```
Migration Status:

Total .bac4 files: 17
‚Ä¢ v2.5.0 (new format): 0
‚Ä¢ v1 (old format): 17
‚Ä¢ Unknown/Error: 0

‚ö†Ô∏è 17 files need migration. Run "Migrate Diagrams to v2.5.0".
```

**What This Tests:**
- Migration service can scan vault
- File version detection works
- Status reporting works

**‚úÖ Pass if:** Shows 17 files needing migration

---

### Step 3: Dry Run Migration (NO CHANGES)

**Command:** `Cmd+P` ‚Üí "Dry Run Migration (Test Only)"

**Expected Result:**
```
Dry run complete!

Would migrate: 17
Would skip: 0
Would fail: 0

No changes were made. Run "Migrate Diagrams to v2.5.0" to perform actual migration.
```

**What This Tests:**
- Format converter can read all v1 files
- Conversion logic works without errors
- No files are actually changed

**‚úÖ Pass if:**
- All 17 files would migrate successfully
- No files would fail
- Vault is unchanged (check file modified dates)

**‚ö†Ô∏è If any files fail:**
- Check console for error details
- Note which files failed
- Examine those files for unexpected format

---

### Step 4: Test Migration on Single File FIRST

**Before migrating all 17 files**, test with the simplest diagram first:

**Command:** `Cmd+P` ‚Üí "Migrate Diagrams to v2.5.0 Format"

**Safety Check:**
1. Modal appears with migration details
2. Read the warning about breaking changes
3. Click "Continue"

**Expected Console Output:**
```
BAC4 v2.5: Starting migration...
BAC4 v2.5: Found 17 .bac4 files
BAC4 v2.5: Migrating: BA-Engineering/test-minimal.bac4
BAC4 v2.5: ‚úÖ Created backup: test-minimal.bac4.v1.backup
BAC4 v2.5: ‚úÖ Wrote node file: test-minimal.bac4
BAC4 v2.5: ‚úÖ Wrote graph file: test-minimal.bac4-graph
BAC4 v2.5: Migration complete: 17 migrated, 0 failed
```

**Expected File Structure After Migration:**

```
BA-Engineering/
‚îú‚îÄ‚îÄ test-minimal.bac4              (NEW: v2.5.0 format, nodes only)
‚îú‚îÄ‚îÄ test-minimal.bac4-graph        (NEW: v2.5.0 format, edges/layout)
‚îú‚îÄ‚îÄ test-minimal.bac4.v1.backup    (BACKUP: original file)
```

**What This Tests:**
- Backup creation works
- Dual-file split works
- File writing works
- Migration service completes without errors

**‚úÖ Pass if:**
- Notice shows "Migration complete! 17 diagrams migrated successfully."
- All 17 .bac4 files exist (modified)
- All 17 .bac4-graph files created (new)
- All 17 .bac4.v1.backup files created (backups)

---

### Step 5: Verify Migration Results

**Check Files:**

```bash
# Count .bac4 files (should be 17)
find BA-Engineering -name "*.bac4" -type f | wc -l

# Count .bac4-graph files (should be 17)
find BA-Engineering -name "*.bac4-graph" -type f | wc -l

# Count backup files (should be 17)
find BA-Engineering -name "*.bac4.v1.backup" -type f | wc -l
```

**Verify test-minimal.bac4 Format:**

Open `BA-Engineering/test-minimal.bac4` and check:

```json
{
  "version": "2.5.0",
  "metadata": {
    "title": "...",
    "diagramType": "...",
    "layer": "...",
    ...
  },
  "nodes": {
    "node-1": {
      "id": "node-1",
      "type": "...",
      "properties": {
        "label": "...",
        "description": "...",
        ...
      },
      "knowledge": {
        "notes": [],
        "urls": [],
        "attachments": []
      },
      "metrics": {},
      "wardley": null,
      "links": {
        "parent": null,
        "children": [],
        "linkedDiagrams": [],
        ...
      },
      "style": {
        "color": "...",
        "icon": "...",
        "shape": "..."
      }
    }
  }
}
```

**Verify test-minimal.bac4-graph Format:**

Open `BA-Engineering/test-minimal.bac4-graph` and check:

```json
{
  "version": "2.5.0",
  "metadata": {
    "nodeFile": "test-minimal.bac4",
    ...
  },
  "timeline": {
    "snapshots": [
      {
        "id": "...",
        "label": "...",
        "timestamp": null,
        "description": "",
        "created": "...",
        "layout": {
          "node-1": {
            "x": 100,
            "y": 100,
            "width": 200,
            "height": 100,
            "locked": false
          }
        },
        "edges": [
          {
            "id": "...",
            "source": "...",
            "target": "...",
            "type": "default",
            "properties": {},
            "style": {
              "direction": "right",
              "lineType": "solid",
              "color": "...",
              "markerEnd": "arrowclosed"
            },
            "handles": {
              "sourceHandle": "right",
              "targetHandle": "left"
            }
          }
        ],
        "groups": [],
        "annotations": []
      }
    ],
    "currentSnapshotId": "...",
    "snapshotOrder": ["..."]
  },
  "config": {
    "defaultLayout": "hierarchical",
    "autoLayout": false
  }
}
```

**‚úÖ Pass if:**
- Semantic data (nodes, properties, knowledge) in .bac4 file
- Layout data (positions, edges) in .bac4-graph file
- All node IDs match between files
- Version is "2.5.0" in both files

---

### Step 6: Test Opening Migrated Diagram

**Open a migrated diagram:**

1. In Obsidian file explorer, navigate to `BA-Engineering/test-minimal.bac4`
2. Click to open in BAC4 canvas view

**Expected Behavior:**

‚úÖ **SUCCESS:** Diagram opens normally, all nodes/edges visible at correct positions

‚ùå **FAILURE:** Error message appears

**If it opens successfully:**
- Verify all nodes are present
- Verify all edges are present
- Verify node positions are correct
- Make a small change (move a node)
- Wait 2 seconds (auto-save debounce)
- Check console for auto-save messages

**Expected Console Output:**
```
BAC4 v2.5: Initializing canvas with filePath: BA-Engineering/test-minimal.bac4
BAC4 v2.5: Loading diagram from dual files: BA-Engineering/test-minimal.bac4
BAC4 v2.5: Files loaded successfully {version: "2.5.0", diagramType: "...", nodeCount: ..., snapshotCount: ...}
BAC4 v2.5: ‚úÖ Diagram loaded successfully
BAC4 v2.5: Auto-save effect triggered
BAC4 v2.5: Starting auto-save to BA-Engineering/test-minimal.bac4
BAC4 v2.5: ‚úÖ Auto-saved successfully
```

**‚úÖ Pass if:**
- Diagram opens without errors
- All data preserved
- Auto-save works correctly
- Both .bac4 and .bac4-graph files update

---

### Step 7: Test Cross-References

**Check linked diagrams still work:**

1. Open `BA-Engineering/4-Context/TechLog-System.bac4`
2. Find a node that links to a Container diagram
3. Double-click the node
4. Verify child diagram opens in new tab

**Expected Behavior:**
- Child diagram opens correctly
- All cross-references preserved
- Navigation works as before

**‚úÖ Pass if:** Cross-diagram navigation still works

---

### Step 8: Test Rollback (Optional)

**‚ö†Ô∏è WARNING: This will undo the migration!**

Only test this if you want to verify rollback works, or if migration failed.

**Command:** `Cmd+P` ‚Üí "Rollback v2.5.0 Migration (Emergency)"

**Expected Behavior:**
1. Modal appears with rollback warning
2. Click "Continue"
3. All .bac4 files restored from .bac4.v1.backup
4. All .bac4-graph files deleted
5. All .bac4.v1.backup files deleted

**After Rollback:**
```bash
# Check .bac4 files restored (should be 17, back to v1 format)
find BA-Engineering -name "*.bac4" -type f | wc -l

# Check .bac4-graph files deleted (should be 0)
find BA-Engineering -name "*.bac4-graph" -type f | wc -l

# Check backups deleted (should be 0)
find BA-Engineering -name "*.bac4.v1.backup" -type f | wc -l
```

**‚úÖ Pass if:**
- All files restored to v1 format
- All .bac4-graph files removed
- All backups removed
- Diagrams open normally again

**If rollback works, you can re-run migration to test again.**

---

## üêõ Troubleshooting

### Problem: "Migration command not found"

**Solution:** Reload Obsidian plugin
```
Cmd+P ‚Üí "Reload app without saving"
```

---

### Problem: Dry run shows failures

**Check console for error details:**
```
BAC4 v2.5: Error converting file: ...
```

**Common issues:**
- Unexpected node structure
- Missing required fields
- Corrupted JSON

**Fix:** Examine failed file, check format, possibly fix manually

---

### Problem: Migration succeeds but diagrams won't open

**Check console for errors:**
```
BAC4 v2.5: Error loading files: ...
```

**Common issues:**
- Node IDs don't match between files
- Missing layout data
- Invalid edge references

**Fix:** Run rollback, report issue, investigate format-converter.ts

---

### Problem: Auto-save not working after migration

**Check console:**
```
BAC4 v2.5: Auto-save effect triggered
BAC4 v2.5: No filePath or files not loaded, skipping auto-save
```

**Issue:** File refs not initialized

**Fix:** Close and reopen diagram

---

### Problem: Cross-references broken after migration

**Check:**
- `links.linkedDiagrams` array in node data
- Paths are correct
- Referenced files exist

**Fix:** Run validateLinkedFiles() logic manually

---

## üìä Success Criteria

‚úÖ **Migration is successful if:**

1. ‚úÖ All 17 files migrate without errors
2. ‚úÖ All .bac4 files contain only semantic data (nodes)
3. ‚úÖ All .bac4-graph files contain only layout/edges
4. ‚úÖ Version "2.5.0" in all files
5. ‚úÖ All diagrams open correctly
6. ‚úÖ All nodes/edges preserved
7. ‚úÖ All node positions preserved
8. ‚úÖ All cross-references work
9. ‚úÖ Auto-save works correctly
10. ‚úÖ Timeline snapshots preserved
11. ‚úÖ Backups created successfully
12. ‚úÖ Rollback works (if tested)

---

## üö® If Tests Fail

**DO NOT PROCEED** if any of these fail:
- Dry run shows failures
- Migration completes but diagrams won't open
- Data is lost or corrupted
- Auto-save doesn't work

**Next Steps:**
1. Run rollback to restore v1 format
2. Check console for detailed errors
3. Review failed file structure
4. Debug format-converter.ts or file-io-service.ts
5. Fix bugs
6. Rebuild plugin
7. Test again

---

## ‚úÖ If Tests Pass

**Congratulations!** The v2.5.0 migration infrastructure is working correctly.

**Next Steps:**

1. **Document the results:**
   - Create test report with screenshots
   - Note any edge cases or issues
   - Document performance (migration speed)

2. **Clean up test vault (optional):**
   - Keep migrated files for further testing
   - Or run rollback to test migration again later

3. **Update version numbers:**
   - Update `manifest.json` to v2.5.0
   - Update `package.json` to v2.5.0

4. **Begin Wardley UI implementation:**
   - See `docs/WARDLEY_MAPPING_PLAN.md`
   - Start with WardleyComponentNode.tsx
   - Estimated 20-25 hours

5. **Or prepare for release:**
   - Create git commit
   - Create GitHub release v2.5.0
   - Update documentation

---

## üìù Test Report Template

```
BAC4 v2.5.0 Migration Test Report
Date: [date]
Tester: [name]
Vault: BAC4Testv09

‚úÖ Step 1: Plugin Reloaded
‚úÖ Step 2: Migration Status - 17 files need migration
‚úÖ Step 3: Dry Run - [migrated/skipped/failed counts]
‚úÖ Step 4: Full Migration - [success/failure]
‚úÖ Step 5: File Verification - [counts match/issues]
‚úÖ Step 6: Open Diagram - [success/failure]
‚úÖ Step 7: Cross-References - [working/broken]
‚úÖ Step 8: Rollback - [tested/skipped]

Overall: [PASS/FAIL]

Notes:
[Any observations, issues, or recommendations]
```

---

## üéØ What's Next After Testing

### If Tests Pass ‚Üí Two Options:

**Option A: Release v2.5.0 Now (Migration Only)**
- Update version to v2.5.0
- Create git commit
- Create GitHub release
- Users can migrate to new format
- Wardley UI comes in v2.6.0

**Option B: Continue to Wardley UI (Complete v2.5.0)**
- Implement Wardley components (20 hours)
- Test Wardley functionality
- Release complete v2.5.0 with migration + Wardley

**Recommendation:** Option B - Complete full v2.5.0 vision

---

**Status:** Ready to Test üöÄ

**Next Action:** Reload Obsidian plugin and begin Step 1
