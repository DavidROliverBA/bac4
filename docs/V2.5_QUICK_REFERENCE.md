# BAC4 v2.5.0 Quick Reference

**Status:** Infrastructure Complete ✅ | Testing Pending ⏳
**Date:** 2025-10-20
**Progress:** 50-60% Complete

---

## 📦 What Was Built

**14 new files | 7,000+ lines of code | Compiles successfully ✅**

### Core Files (Infrastructure)

```
src/types/bac4-v2-types.ts              380 lines   Type system
src/types/wardley-types.ts              350 lines   Wardley types
src/utils/format-converter.ts           450 lines   v1→v2 conversion
src/services/migration-service.ts       450 lines   Migration tool
src/services/file-io-service.ts         584 lines   Dual-file I/O
src/ui/canvas/hooks/useFileOperations-v2.ts  323 lines   File ops hook
src/main.ts                             +202 lines  Migration commands
```

### Documentation

```
docs/WARDLEY_MAPPING_PLAN.md            500+ lines  Implementation plan
docs/WARDLEY_MAPPING_COMPARISON.md      400+ lines  Tech comparison
docs/V2.5_REFACTOR_PLAN.md              600+ lines  Refactor plan
docs/MAIN_TS_MIGRATION_COMMANDS.md      322 lines   Command guide
docs/V2.5_IMPLEMENTATION_STATUS.md      412 lines   Progress tracker
docs/V2.5_TESTING_GUIDE.md              550+ lines  Testing manual
docs/V2.5_COMPLETION_SUMMARY.md         (large)     Session summary
docs/V2.5_QUICK_REFERENCE.md            (this)      Quick ref
```

---

## 🏗️ Architecture: Before vs After

### Before (v1/v2.x): Single File

```json
diagram.bac4
{
  "version": "1.0.0",
  "nodes": [{x, y, data: {...}}],  // Mixed semantic + layout
  "edges": [...],
  "timeline": {...}
}
```

### After (v2.5.0): Dual Files

```json
diagram.bac4  (semantic data)
{
  "version": "2.5.0",
  "nodes": {
    "node-1": {
      "properties": {label, description, ...},
      "knowledge": {notes, urls, attachments},
      "metrics": {uptime, cost, users},
      "wardley": {visibility, evolution, inertia},
      "links": {parent, children, linkedDiagrams},
      "style": {color, icon, shape}
    }
  }
}

diagram.bac4-graph  (presentation data)
{
  "version": "2.5.0",
  "timeline": {
    "snapshots": [{
      "layout": {"node-1": {x, y, width, height}},
      "edges": [...],
      "annotations": [...]
    }]
  }
}
```

---

## ⚡ Quick Start Testing

### 1. Reload Plugin

```
Open Obsidian → Cmd+P → "Reload app without saving"
```

### 2. Check Status

```
Cmd+P → "Show Migration Status"
Expected: 17 files need migration
```

### 3. Dry Run (No Changes)

```
Cmd+P → "Dry Run Migration (Test Only)"
Expected: Would migrate 17, fail 0
```

### 4. Migrate (With Backups)

```
Cmd+P → "Migrate Diagrams to v2.5.0 Format"
Click "Continue" → Wait for completion
Expected: 17 migrated successfully
```

### 5. Verify

```bash
# Check files created
ls BA-Engineering/test-minimal.bac4        # ✅ Updated (v2.5.0)
ls BA-Engineering/test-minimal.bac4-graph  # ✅ New
ls BA-Engineering/test-minimal.bac4.v1.backup  # ✅ Backup
```

### 6. Open Diagram

```
File Explorer → test-minimal.bac4 → Click
Expected: Opens normally, all data preserved
```

### 7. (Optional) Rollback

```
Cmd+P → "Rollback v2.5.0 Migration (Emergency)"
Expected: Restores v1 format, deletes .bac4-graph
```

---

## 🔧 New Commands

| Command | Purpose | Safety |
|---------|---------|--------|
| **Migrate Diagrams to v2.5.0** | Convert all files | ✅ Creates backups |
| **Dry Run Migration** | Test without changes | ✅ Read-only |
| **Rollback Migration** | Emergency restore | ✅ Restores from backup |
| **Show Migration Status** | Check vault status | ✅ Read-only |

---

## 📊 Test Vault Status

**Location:** `/Users/david.oliver/Documents/Vaults/BAC4Testv09`

**Files:** 17 .bac4 diagrams (all v1 format, ready to migrate)

```
Layer 1: Market         1 diagram
Layer 2: Organisation   1 diagram
Layer 3: Capability     1 diagram
Layer 4: Context        2 diagrams
Layer 5: Container      2 diagrams
Layer 6: Component      4 diagrams
Layer 7: Code           5 diagrams
Test:    test-minimal   1 diagram
                       ──────────
Total:                 17 diagrams
```

---

## ✅ Build Status

```bash
$ npm run build
  main.js  752.9kb
⚡ Done in 56ms
✅ No errors
✅ Copied to: BAC4Testv09/.obsidian/plugins/bac4/
```

---

## 🧪 Testing Checklist

- [ ] Reload Obsidian plugin
- [ ] Run "Show Migration Status" → 17 files need migration
- [ ] Run "Dry Run Migration" → 17 would migrate, 0 fail
- [ ] Run "Migrate Diagrams to v2.5.0" → Success
- [ ] Check files: .bac4 (updated), .bac4-graph (new), .bac4.v1.backup (backup)
- [ ] Open test-minimal.bac4 → Loads correctly
- [ ] Verify data: All nodes/edges/positions preserved
- [ ] Test auto-save: Move node → Wait 2s → Files update
- [ ] Test cross-references: Navigate to linked diagram
- [ ] (Optional) Test rollback → Restores v1 format

**Pass Criteria:** All checkboxes ✅

---

## 📈 Progress

| Component | Status |
|-----------|--------|
| Type System | ✅ 100% |
| Format Converter | ✅ 100% |
| Migration Service | ✅ 100% |
| File I/O Service | ✅ 100% |
| File Operations Hook | ✅ 100% |
| Migration Commands | ✅ 100% |
| Documentation | ✅ 100% |
| **Testing** | ⏳ 0% |
| **Wardley UI** | 🚧 0% |
| **v2.5.0 TOTAL** | **🚧 55%** |

---

## 🎯 Next Steps

### After Testing Passes:

**Option A: Release v2.5.0 Now (Migration Only)**
- Update version to v2.5.0
- Git commit + GitHub release
- Wardley UI comes in v2.6.0
- **ETA:** 2-3 hours

**Option B: Continue to Wardley UI (Full v2.5.0)**
- Implement 6 Wardley UI components
- Test Wardley functionality
- Release complete v2.5.0
- **ETA:** 24-30 hours

**Recommendation:** Test first, then decide

---

## 🚨 If Tests Fail

1. Check console for errors
2. Run rollback to restore v1
3. Review error details
4. Debug format-converter.ts or file-io-service.ts
5. Fix bugs
6. Rebuild: `npm run build`
7. Copy to vault
8. Test again

---

## 📚 Documentation

| Document | Purpose |
|----------|---------|
| **V2.5_TESTING_GUIDE.md** | Complete testing manual with step-by-step instructions |
| **V2.5_COMPLETION_SUMMARY.md** | Detailed summary of what was built |
| **V2.5_IMPLEMENTATION_STATUS.md** | Progress tracker with phase breakdown |
| **V2.5_REFACTOR_PLAN.md** | Original plan with architecture details |
| **WARDLEY_MAPPING_PLAN.md** | Wardley UI implementation plan |
| **V2.5_QUICK_REFERENCE.md** | This document (quick overview) |

---

## 🔑 Key Files to Understand

### Type System
```typescript
// src/types/bac4-v2-types.ts
export interface BAC4FileV2 {
  version: '2.5.0';
  metadata: DiagramMetadata;
  nodes: Record<string, NodeV2>;
}

export interface NodeV2 {
  id: string;
  type: NodeType;
  properties: NodeProperties;
  knowledge: Knowledge;      // NEW: notes, URLs
  metrics?: Metrics;         // NEW: uptime, cost
  wardley?: WardleyProperties;  // NEW: visibility, evolution
  links: NodeLinks;
  style: NodeStyle;
}
```

### Migration
```typescript
// src/services/migration-service.ts
const migrationService = new MigrationService(app);

// Test without changes
await migrationService.dryRunMigration();

// Migrate with backups
await migrationService.migrateAllDiagrams({
  dryRun: false,
  createBackups: true
});

// Emergency restore
await migrationService.rollbackMigration();
```

### File I/O
```typescript
// src/services/file-io-service.ts

// Read both files
const { nodeFile, graphFile } = await readDiagram(vault, 'diagram.bac4');

// Merge for React Flow
const nodes = mergeNodesAndLayout(nodeFile, graphFile);
const edges = getEdgesFromGraph(graphFile);

// Split for saving
const { nodeFile, graphFile } = splitNodesAndEdges(
  reactFlowNodes,
  reactFlowEdges,
  currentNodeFile,
  currentGraphFile
);

// Write both files
await writeDiagram(vault, 'diagram.bac4', nodeFile, graphFile);
```

---

## 🎓 Design Principles

1. **Separation of Concerns:** Semantic data (what) vs presentation (how)
2. **Graph Database Ready:** Format matches Neo4j node/relationship model
3. **Backward Migration:** Can convert v2→v1 if needed (for transition)
4. **Safety First:** Backups, validation, rollback
5. **Extensibility:** Easy to add new properties (knowledge, metrics, wardley)
6. **Multiple Views:** Same data can have different layouts
7. **Rich Metadata:** Notes, URLs, attachments, metrics

---

## 💡 Key Insights

### Why Dual Files?

**Problem:** Single file mixes "what components are" with "where they're positioned"

**Solution:** Two files = clean separation
- `.bac4` = What is this component? (semantic)
- `.bac4-graph` = How is it displayed? (presentation)

**Benefits:**
- Can create multiple views of same data
- Easier to query just properties
- Graph database ready (nodes/relationships)
- Can change layout without touching semantic data

### Why Breaking Change?

**Reason:** Old format was limiting future features

**Mitigation:**
- Automatic migration tool
- Backups created
- Rollback command
- Extensive testing
- Comprehensive docs

**Result:** Clean architecture for future (Wardley, Neo4j, AI analysis)

---

## 🚀 Ready to Test?

**→ See `docs/V2.5_TESTING_GUIDE.md` for complete instructions**

**Quick Start:**
1. Open Obsidian with BAC4Testv09 vault
2. Reload plugin (Cmd+P → Reload)
3. Run "Show Migration Status"
4. Run "Dry Run Migration"
5. If dry run passes → Run "Migrate Diagrams"
6. Open test-minimal.bac4
7. Verify everything works

**Time Required:** 30-60 minutes

---

## 📞 Questions?

**Check:**
1. `V2.5_TESTING_GUIDE.md` - Step-by-step testing
2. `V2.5_COMPLETION_SUMMARY.md` - What we built
3. `V2.5_REFACTOR_PLAN.md` - Architecture details
4. Console logs - Detailed debug output

**Common Issues:**
- Commands not found → Reload plugin
- Migration fails → Check console, run rollback
- Diagram won't open → Check file format, validate JSON

---

**Status:** Ready to Test! 🚀

**Next Action:** Open Obsidian → Reload Plugin → Test Migration

**Confidence:** High - All code compiles, architecture is solid, safety features in place.
